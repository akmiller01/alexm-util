<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Dynamic P20 Venn</title>
    <style>
        body {
            font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 14px;
        }
        
        th {
            text-align:left;
        }
        select#isoSelect {
            font-size: 1em;
            margin:0.67em;
            -webkit-margin-before: 0.67em;
            -webkit-margin-after: 0.67em;
            -webkit-margin-start: 0px;
            -webkit-margin-end: 0px;
        }
        
        h1 {
          font-family: Arial;
          font-weight: normal;
        }
        
        table {float:left;}
    </style>
</head>

<body>
    <h1>Venn diagram comparing demographics in
    <select id="isoSelect"></select>
    </h1>
<div style="float:left;padding:20px;width:100%">
    <table>
    <tr>
        <th>Indicator 1</th>
        <th>Indicator 2</th>
        <th>Indicator 3</th>
    </tr>
    <tr>
        <td>
            <select id="Xselect" class="indicator">
            </select>
        </td>
        <td>
            <select id="Yselect" class="indicator">
            </select>
        </td>
        <td>
            <select id="Zselect" class="indicator">
            </select>
        </td>
    </tr>
    </table>
</div>
<div id="venn"></div>
<div id="err" style="height:500px;width:600px;text-align:center;display:none;">
    <b>Sorry, cannot display the combination of these variables.</b>
</div>
<div style="float:left;padding:20px;width:100%">
    <table>
    <tr>
      <td id="Xlabel">X</td>
      <td>
        <input class="input-mini venn_area" id="X" readonly>
      </td>
    </tr>
    <tr>
      <td id="Ylabel">Y</td>
      <td>
        <input class="input-mini venn_area" id="Y" readonly>
      </td>
    </tr>
    <tr>
      <td id="Zlabel">Z</td>
      <td>
        <input class="input-mini venn_area" id="Z" readonly>
      </td>
    </tr>
    <tr>
      <td id="X,Ylabel">X&#8745Y</td>
      <td>
        <input class="input-mini venn_area" id="X,Y" readonly>
      </td>
    </tr>
    <tr>
      <td id="X,Zlabel">X&#8745Z</td>
      <td>
        <input class="input-mini venn_area" id="X,Z" readonly>
      </td>
    </tr>
    <tr>
      <td id="Y,Zlabel">Y&#8745Z</td>
      <td>
        <input class="input-mini venn_area" id="Y,Z" readonly>
      </td>
    </tr>
    <tr>
      <td id="X,Y,Zlabel">X&#8745Y&#8745Z</td>
      <td>
        <input class="input-mini venn_area" id="X,Y,Z" readonly>
      </td>
    </tr>
    </table>
</div>
<div style="clear: both;"></div>

</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="venn.js"></script>
<script>
Array.prototype.compare = function(testArr) {
    if (this.length != testArr.length) return false;
    for (var i = 0; i < testArr.length; i++) {
        if (this[i].compare) { //To test values in nested arrays
            if (!this[i].compare(testArr[i])) return false;
        }
        else if (this[i] !== testArr[i]) return false;
    }
    return true;
}

function numberWithCommas(x) {
	var millions = Math.round((x/100)/100000)/10;
    return millions.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+ " million";
};

var isoDict = {"AD":"Andorra"
,"AE":"UAE"
,"AF":"Afghanistan"
,"AG":"Antigua & Barbuda"
,"AI":"Anguilla"
,"AL":"Albania"
,"AM":"Armenia"
,"AO":"Angola"
,"AQ":"Antarctica"
,"AR":"Argentina"
,"AS":"American Samoa"
,"AT":"Austria"
,"AU":"Australia"
,"AW":"Aruba"
,"AX":"Aland Islands"
,"AZ":"Azerbaijan"
,"BA":"Bosnia & Herzegovina"
,"BB":"Barbados"
,"BD":"Bangladesh"
,"BE":"Belgium"
,"BF":"Burkina Faso"
,"BG":"Bulgaria"
,"BH":"Bahrain"
,"BI":"Burundi"
,"BJ":"Benin"
,"BL":"Saint Barthelemy"
,"BM":"Bermuda"
,"BN":"Brunei"
,"BO":"Bolivia "
,"BQ":"BES Islands"
,"BR":"Brazil"
,"BS":"Bahamas"
,"BT":"Bhutan"
,"BV":"Bouvet Island"
,"BW":"Botswana"
,"BY":"Belarus"
,"BZ":"Belize"
,"CA":"Canada"
,"CC":"Cocos (Keeling) Islands"
,"CD":"DRC"
,"CF":"CAR"
,"CG":"Congo"
,"CH":"Switzerland"
,"CI":"Cote d'Ivoire"
,"CK":"Cook Islands"
,"CL":"Chile"
,"CM":"Cameroon"
,"CN":"China"
,"CO":"Colombia"
,"CR":"Costa Rica"
,"CU":"Cuba"
,"CV":"Cape Verde"
,"CW":"Curacao"
,"CX":"Christmas Island"
,"CY":"Cyprus"
,"CZ":"Czech Republic"
,"DE":"Germany"
,"DJ":"Djibouti"
,"DK":"Denmark"
,"DM":"Dominica"
,"DO":"Dominican Republic"
,"DZ":"Algeria"
,"EC":"Ecuador"
,"EE":"Estonia"
,"EG":"Egypt"
,"EH":"Western Sahara"
,"ER":"Eritrea"
,"ES":"Spain"
,"ET":"Ethiopia"
,"FI":"Finland"
,"FJ":"Fiji"
,"FK":"Falkland Islands "
,"FM":"Micronesia"
,"FO":"Faroe Islands"
,"FR":"France"
,"GA":"Gabon"
,"GB":"UK"
,"GD":"Grenada"
,"GE":"Georgia"
,"GF":"French Guiana"
,"GG":"Guernsey"
,"GH":"Ghana"
,"GI":"Gibraltar"
,"GL":"Greenland"
,"GM":"Gambia"
,"GN":"Guinea"
,"GP":"Guadeloupe"
,"GQ":"Equatorial Guinea"
,"GR":"Greece"
,"GS":"South Georgia & the South Sandwich Islands"
,"GT":"Guatemala"
,"GU":"Guam"
,"GW":"Guinea-Bissau"
,"GY":"Guyana"
,"HK":"Hong Kong"
,"HM":"Heard Island & McDonald Islands"
,"HN":"Honduras"
,"HR":"Croatia"
,"HT":"Haiti"
,"HU":"Hungary"
,"ID":"Indonesia"
,"IE":"Ireland"
,"IL":"Israel"
,"IM":"Isle of Man"
,"IN":"India"
,"IO":"British Indian Ocean Territory"
,"IQ":"Iraq"
,"IR":"Iran"
,"IS":"Iceland"
,"IT":"Italy"
,"JE":"Jersey"
,"JM":"Jamaica"
,"JO":"Jordan"
,"JP":"Japan"
,"KE":"Kenya"
,"KG":"Kyrgyzstan"
,"KH":"Cambodia"
,"KI":"Kiribati"
,"KM":"Comoros"
,"KN":"Saint Kitts and Nevis"
,"KP":"North Korea"
,"KR":"South Korea"
,"KW":"Kuwait"
,"KY":"Cayman Islands"
,"KZ":"Kazakhstan"
,"LA":"Lao"
,"LB":"Lebanon"
,"LC":"Saint Lucia"
,"LI":"Liechtenstein"
,"LK":"Sri Lanka"
,"LR":"Liberia"
,"LS":"Lesotho"
,"LT":"Lithuania"
,"LU":"Luxembourg"
,"LV":"Latvia"
,"LY":"Libya"
,"MA":"Morocco"
,"MC":"Monaco"
,"MD":"Moldova"
,"ME":"Montenegro"
,"MF":"Saint Martin "
,"MG":"Madagascar"
,"MH":"Marshall Islands"
,"MK":"Macedonia"
,"ML":"Mali"
,"MM":"Myanmar"
,"MN":"Mongolia"
,"MO":"Macao"
,"MP":"Northern Mariana Islands"
,"MQ":"Martinique"
,"MR":"Mauritania"
,"MS":"Montserrat"
,"MT":"Malta"
,"MU":"Mauritius"
,"MV":"Maldives"
,"MW":"Malawi"
,"MX":"Mexico"
,"MY":"Malaysia"
,"MZ":"Mozambique"
,"NA":"Namibia"
,"NC":"New Caledonia"
,"NE":"Niger"
,"NF":"Norfolk Island"
,"NG":"Nigeria"
,"NI":"Nicaragua"
,"NL":"Netherlands"
,"NO":"Norway"
,"NP":"Nepal"
,"NR":"Nauru"
,"NU":"Niue"
,"NZ":"New Zealand"
,"OM":"Oman"
,"PA":"Panama"
,"PE":"Peru"
,"PF":"French Polynesia"
,"PG":"Papua New Guinea"
,"PH":"Philippines"
,"PK":"Pakistan"
,"PL":"Poland"
,"PM":"Saint Pierre & Miquelon"
,"PN":"Pitcairn"
,"PR":"Puerto Rico"
,"PS":"Palestine"
,"PT":"Portugal"
,"PW":"Palau"
,"PY":"Paraguay"
,"QA":"Qatar"
,"RE":"Reunion"
,"RO":"Romania"
,"RS":"Serbia"
,"RU":"Russian Federation"
,"RW":"Rwanda"
,"SA":"Saudi Arabia"
,"SB":"Solomon Islands"
,"SC":"Seychelles"
,"SD":"Sudan"
,"SE":"Sweden"
,"SG":"Singapore"
,"SH":"Saint Helena, Ascension & Tristan da Cunha"
,"SI":"Slovenia"
,"SJ":"Svalbard & Jan Mayen"
,"SK":"Slovakia"
,"SL":"Sierra Leone"
,"SM":"San Marino"
,"SN":"Senegal"
,"SO":"Somalia"
,"SR":"Suriname"
,"SS":"South Sudan"
,"ST":"Sao Tome & Principe"
,"SV":"El Salvador"
,"SX":"Sint Maarten (Dutch part)"
,"SY":"Syria"
,"SZ":"Swaziland"
,"TC":"Turks & Caicos Islands"
,"TD":"Chad"
,"TF":"French Southern Territories"
,"TG":"Togo"
,"TH":"Thailand"
,"TJ":"Tajikistan"
,"TK":"Tokelau"
,"TL":"Timor-Leste"
,"TM":"Turkmenistan"
,"TN":"Tunisia"
,"TO":"Tonga"
,"TR":"Turkey"
,"TT":"Trinidad & Tobago"
,"TV":"Tuvalu"
,"TW":"Taiwan"
,"TZ":"Tanzania"
,"UA":"Ukraine"
,"UG":"Uganda"
,"UM":"United States Minor Outlying Islands"
,"US":"USA"
,"UY":"Uruguay"
,"UZ":"Uzbekistan"
,"VA":"Holy See (Vatican City State)"
,"VC":"Saint Vincent & the Grenadines"
,"VE":"Venezuela"
,"VG":"Virgin Islands (GB)"
,"VI":"Virgin Islands (US)"
,"VN":"Viet Nam"
,"VU":"Vanuatu"
,"WF":"Wallis & Futuna"
,"WS":"Samoa"
,"XK":"Kosovo"
,"YE":"Yemen"
,"YT":"Mayotte"
,"ZA":"South Africa"
,"ZM":"Zambia"
,"ZW":"Zimbabwe"
,"EU":"European Union"
,"WD":"The World (surveyed country average)"};

var indicatorDict = {
 "blank1":"None"
 ,"blank2":"None"
 ,"p20":"P20"
 ,"non.p20":"Population not in the P20"
 ,"ext":"Extreme poverty"
 ,"no.birth.reg":"Birth not registered"
 ,"female":"Female"
 ,"male":"Male"
 ,"under5":"Younger than 5"
 ,"fiveto14":"Aged 5 to 14"
 ,"fifteento49":"Aged 15 to 49"
 ,"gt49":"Older than 49"
 ,"no.educ":"No education or preschool"
 ,"primary":"Primary education"
 ,"secondary":"Secondary education"
 ,"higher":"Higher education"
 ,"urban":"Urban"
 ,"rural":"Rural"
 ,"no.skilled.attendant":"Had no skilled birth attendants"
 ,"stunted":"Experiencing stunting"
};
var indicators = Object.keys(indicatorDict);

function ensureUnique() {
    var $selects = $('select.indicator');
    var values = [$selects[0].value,$selects[1].value,$selects[2].value];
    //var counts = {};
    //for(var i = 0; i< values.length; i++) {
    //    var num = values[i];
    //    counts[num] = counts[num] ? counts[num]+1 : 1;
    //};
    //var uniqueLength = counts["none"]>=1?(d3.map(values,function(d){return d;}).keys().length - 1):d3.map(values,function(d){return d;}).keys().length;
    //var desiredLength = values.length - counts["none"];
    var uniqueLength = d3.map(values,function(d){return d;}).keys().length;
    while (uniqueLength!=3) {
        if ($('#Yselect option:selected').val()==values[0]) {
            var option = $('#Yselect option:selected').next();
            if (option.length==0) {
                var option = $('#Yselect option').first();
            };
            option[0].selected=true
            var values = [$selects[0].value,$selects[1].value,$selects[2].value];
            var uniqueLength = d3.map(values,function(d){return d;}).keys().length;
        };
        if (values[1]==values[2]) {
            var option = $('#Zselect option:selected').next();
            if (option.length==0) {
                var option = $('#Zselect option').first();
            };
            option[0].selected=true
            var values = [$selects[0].value,$selects[1].value,$selects[2].value];
            var uniqueLength = d3.map(values,function(d){return d;}).keys().length;
        };
        if (values[2]==values[0]){
            var option = $('#Zselect option:selected').next();
            if (option.length==0) {
                var option = $('#Zselect option').first();
            };
            option[0].selected=true
            var values = [$selects[0].value,$selects[1].value,$selects[2].value];
            var uniqueLength = d3.map(values,function(d){return d;}).keys().length;
        };
    };
    return(values)
};

d3.csv('all.venn.joined.csv',function(data){
    var isos = d3.map(data,function(d){return d.iso2;}).keys();
    var isoSelect = d3.select("#isoSelect");
    
    isoSelect.selectAll("option.iso").data(isos).enter().append("option")
        .attr('class','iso')
        .attr('value',function(d){return d})
        .text(function(d){return isoDict[d];});
    function changeVenn() {
        var iso2 = $("#isoSelect").val();
        var values = ensureUnique().sort();
        for (var i=values.length-1; i>=0; i--) {
            if (values[i] === "blank1") {
                values.splice(i, 1);
            }else if (values[i] === "blank2") {
                values.splice(i, 1);
            }
        };
        //One choice
        if (values.length==1) {
            var fullValues = [values[0],"blank1","blank2"].sort();
            var subset = data.filter(function(d){
                var indicatorSet = [d.indicator1,d.indicator2,d.indicator3].sort();
                return(fullValues.compare(indicatorSet) && d.iso2==iso2);
            })[0];
            if (subset.indicator1==values[0]) {
                var areas = [
                                {sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                            ];
                $('#X').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
                $('#Xlabel').text(indicatorDict[subset.indicator1])
            }else if (subset.indicator2==values[0]) {
                var areas = [
                                {sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                            ];
                $('#X').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
                $('#Xlabel').text(indicatorDict[subset.indicator2])
            }else if (subset.indicator3==values[0]) {
                var areas = [
                                {sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                            ];
                $('#X').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
                $('#Xlabel').text(indicatorDict[subset.indicator3])
            };
            
            $('#Y').val("")
            $('#Z').val("")
            $('#X\\,Y').val("")
            $('#X\\,Z').val("")
            $('#Y\\,Z').val("")
            $('#X\\,Y\\,Z').val("")
            $('#Ylabel').text("")
            $('#Zlabel').text("")
            $('#X\\,Ylabel').text("")
            $('#X\\,Zlabel').text("")
            $('#Y\\,Zlabel').text("")
            $('#X\\,Y\\,Zlabel').text("")
            //Two choice
        }else if (values.length==2) {
            var fullValues = [values[0],values[1],"blank1"].sort();
            var subset = data.filter(function(d){
                var indicatorSet = [d.indicator1,d.indicator2,"blank1"].sort();
                return(fullValues.compare(indicatorSet) && d.iso2==iso2);
            })[0];
            if (subset.indicator1==values[0]) {
                if (subset.indicator2==values[1]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                                    ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                                    ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%",indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset['X,Y']}
                                ];
                    $('#X').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
                    $('#Y').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
                    $('#X\\,Y').val(subset['X,Y']==""?"":subset['X,Y']+"%, or about "+numberWithCommas(subset['X,Y']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator1])
                    $('#Ylabel').text(indicatorDict[subset.indicator2])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator1]+" and "+indicatorDict[subset.indicator2])
                }else if (subset.indicator2==values[2]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                                    ,{sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                                    ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%",indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset['X,Z']}
                                ];
                    $('#X').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
                    $('#Y').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
                    $('#X\\,Y').val(subset['X,Z']==""?"":subset['X,Z']+"%, or about "+numberWithCommas(subset['X,Z']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator1])
                    $('#Ylabel').text(indicatorDict[subset.indicator3])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator1]+" and "+indicatorDict[subset.indicator3])
                };
            }else if (subset.indicator1==values[1]) {
                if (subset.indicator2==values[0]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                                    ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                                    ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%",indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset['X,Y']}
                                ];
                    $('#X').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
                    $('#Y').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
                    $('#X\\,Y').val(subset['X,Y']==""?"":subset['X,Y']+"%, or about "+numberWithCommas(subset['X,Y']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator2])
                    $('#Ylabel').text(indicatorDict[subset.indicator1])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator2]+" and "+indicatorDict[subset.indicator1])
                }else if (subset.indicator2==values[2]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                                    ,{sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                                    ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%",indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset['Y,Z']}
                                ];
                    $('#X').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
                    $('#Y').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
                    $('#X\\,Y').val(subset['Y,Z']==""?"":subset['Y,Z']+"%, or about "+numberWithCommas(subset['Y,Z']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator2])
                    $('#Ylabel').text(indicatorDict[subset.indicator3])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator2]+" and "+indicatorDict[subset.indicator3])
                };
            }else if (subset.indicator1==values[2]) {
                if (subset.indicator2==values[0]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                                    ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                                    ,{sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%",indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset['X,Z']}
                                ];
                    $('#X').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
                    $('#Y').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
                    $('#X\\,Y').val(subset['X,Z']==""?"":subset['X,Z']+"%, or about "+numberWithCommas(subset['X,Z']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator3])
                    $('#Ylabel').text(indicatorDict[subset.indicator1])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator3]+" and "+indicatorDict[subset.indicator1])
                }else if (subset.indicator2==values[1]) {
                    var areas = [
                                    {sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                                    ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                                    ,{sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%",indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset['Y,Z']}
                                ];
                    $('#X').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
                    $('#Y').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
                    $('#X\\,Y').val(subset['Y,Z']==""?"":subset['Y,Z']+"%, or about "+numberWithCommas(subset['Y,Z']*subset.pop))
                    $('#Xlabel').text(indicatorDict[subset.indicator3])
                    $('#Ylabel').text(indicatorDict[subset.indicator2])
                    $('#X\\,Ylabel').text(indicatorDict[subset.indicator3]+" and "+indicatorDict[subset.indicator2])
                };
            };
            $('#Z').val("")
            $('#X\\,Z').val("")
            $('#Y\\,Z').val("")
            $('#X\\,Y\\,Z').val("")
            $('#Zlabel').text("")
            $('#X\\,Zlabel').text("")
            $('#Y\\,Zlabel').text("")
            $('#X\\,Y\\,Zlabel').text("")
        }else if (values.length==3) {
            var subset = data.filter(function(d){
                var indicatorSet = [d.indicator1,d.indicator2,d.indicator3].sort();
                return(values.compare(indicatorSet) && d.iso2==iso2);
            })[0];
            var areas = [
                            {sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%"],size:subset.X}
                            ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset.Y}
                            ,{sets:[indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset.Z}
                            ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%",indicatorDict[subset.indicator2]+" – "+subset.Y+"%"],size:subset['X,Y']}
                            ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%",indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset['X,Z']}
                            ,{sets:[indicatorDict[subset.indicator2]+" – "+subset.Y+"%",indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset['Y,Z']}
                            ,{sets:[indicatorDict[subset.indicator1]+" – "+subset.X+"%",indicatorDict[subset.indicator2]+" – "+subset.Y+"%",indicatorDict[subset.indicator3]+" – "+subset.Z+"%"],size:subset['X,Y,Z']}
                        ];
            $('#X').val(subset.X==""?"":subset.X+"%, or about "+numberWithCommas(subset.X*subset.pop))
            $('#Y').val(subset.Y==""?"":subset.Y+"%, or about "+numberWithCommas(subset.Y*subset.pop))
            $('#Z').val(subset.Z==""?"":subset.Z+"%, or about "+numberWithCommas(subset.Z*subset.pop))
            $('#X\\,Y').val(subset['X,Y']==""?"":subset['X,Y']+"%, or about "+numberWithCommas(subset['X,Y']*subset.pop))
            $('#X\\,Z').val(subset['X,Z']==""?"":subset['X,Z']+"%, or about "+numberWithCommas(subset['X,Z']*subset.pop))
            $('#Y\\,Z').val(subset['Y,Z']==""?"":subset['Y,Z']+"%, or about "+numberWithCommas(subset['Y,Z']*subset.pop))
            $('#X\\,Y\\,Z').val(subset['X,Y,Z']==""?"":subset['X,Y,Z']+"%, or about "+numberWithCommas(subset['X,Y,Z']*subset.pop))
            $('#Xlabel').text(indicatorDict[subset.indicator1])
            $('#Ylabel').text(indicatorDict[subset.indicator2])
            $('#Zlabel').text(indicatorDict[subset.indicator3])
            $('#X\\,Ylabel').text(indicatorDict[subset.indicator1]+" and "+indicatorDict[subset.indicator2])
            $('#X\\,Zlabel').text(indicatorDict[subset.indicator1]+" and "+indicatorDict[subset.indicator3])
            $('#Y\\,Zlabel').text(indicatorDict[subset.indicator2]+" and "+indicatorDict[subset.indicator3])
            $('#X\\,Y\\,Zlabel').text(indicatorDict[subset.indicator1]+" and "+indicatorDict[subset.indicator2]+" and "+indicatorDict[subset.indicator3])
        };

        if (d3.sum([subset.X,subset.Y,subset.Z,subset['Y,Z'],subset['X,Z'],subset['X,Y'],subset['X,Y,Z']])<=0) {
            $('div#venn').hide()
            $('div#err').show()
        }else{
            $('div#err').hide()
            $('div#venn').show()
            try{
                d3.select("#venn").datum(areas).call(chart);   
            }catch(err){
                console.log(err)
                $('div#venn').hide()
                $('div#err').show()
            }
            // tweak style
            var colours = d3.scaleOrdinal().range(["rgb(143,28,20)","rgb(189,39,41)","rgb(240,131,110)","rgb(232,68,58)"])
            d3.selectAll("#venn .venn-circle path")
                .style("stroke-width", 1)
                .style("stroke-opacity", .5)
                .style("stroke", function(d,i) { return colours(i); })
                .style("fill", function(d,i) { return colours(i); });
            
            d3.selectAll("#venn .venn-circle text")
                .style("fill", function(d,i) { return colours(i)});
        };
        
    };
    var dropdowns = d3.selectAll('select');
    dropdowns.on("change",changeVenn);
    var indicatorDropdown1 = d3.selectAll('select#Xselect');
    var indicatorDropdown2 = d3.selectAll('select#Yselect');
    var indicatorDropdown3 = d3.selectAll('select#Zselect');
    indicatorDropdown1.selectAll('option.indicator').data(["p20","non.p20","ext"])
        .enter().append("option")
        .attr('value',function(d){return d})
        .attr('class','indicator')
        .text(function(d){return indicatorDict[d];});
    var choices1 = [
        "blank1"
        ,"p20"
        ,"non.p20"
        ,"ext"
        ,"no.birth.reg"
        ,"female"
        ,"male"
        ,"under5"
        ,"fiveto14"
        ,"fifteento49"
        ,"gt49"
        ,"no.educ"
        ,"primary"
        ,"secondary"
        ,"higher"
        ,"urban"
        ,"rural"
        ,"no.skilled.attendant"
        ,"stunted"
    ];
    var choices2 = [
        "blank2"
        ,"p20"
        ,"non.p20"
        ,"ext"
        ,"no.birth.reg"
        ,"female"
        ,"male"
        ,"under5"
        ,"fiveto14"
        ,"fifteento49"
        ,"gt49"
        ,"no.educ"
        ,"primary"
        ,"secondary"
        ,"higher"
        ,"urban"
        ,"rural"
        ,"no.skilled.attendant"
        ,"stunted"
    ];
    indicatorDropdown2.selectAll('option.indicator').data(choices1)
        .enter().append("option")
        .attr('value',function(d){return d})
        .attr('class','indicator')
        .text(function(d){return indicatorDict[d];});
    indicatorDropdown3.selectAll('option.indicator').data(choices2)
        .enter().append("option")
        .attr('value',function(d){return d})
        .attr('class','indicator')
        .text(function(d){return indicatorDict[d];});
    changeVenn();
});

// draw the initial set
var chart = venn.VennDiagram()
                 .width(600)
                 .height(500);
</script>
</html>
